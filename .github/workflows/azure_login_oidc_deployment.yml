name: Run Azure deployment with OIDC login
on: workflow_dispatch

permissions:
      id-token: write
      contents: write
jobs: 
  az-login-test:
    runs-on: self-hosted
    steps:
      - name: Check out current repo 
        uses: actions/checkout@v2
      - name: Check out app's repo
        uses: actions/checkout@v2
        with:
          repository: Azure-Samples/pythonSample_thecatsaidno
          ref: master
          path: 'pythonSample_thecatsaidno'
      - name: Installing CLI-beta for OIDC and apps dependencies 
        run: |
           pwd 
           python3 -m venv oidc-venv
           ls
           . oidc-venv/bin/activate
           python3 -m pip install --upgrade pip
           pip install --extra-index-url https://azurecliedge.blob.core.windows.net/federated-token/simple/ azure-cli
           pip install -r pythonSample_thecatsaidno/requirements.txt
           
      - name: 'Az CLI login without subscription'
        uses: 'balaga-gayatri/login@oidc-support'
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_OIDC }}
#           allow-no-subscriptions: true
#           enable-AzPSSession: true
          
      - run: |
          pwd
          . ~/oidc-venv/bin/activate
          az account show
          az group list
          pwd 
